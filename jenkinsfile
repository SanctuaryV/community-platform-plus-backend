pipeline {
    agent any

    parameters {
        string(name: 'REPO_URL', defaultValue: 'https://github.com/SanctuaryV/community-platform-plus-backend.git', description: 'Git repo URL')
        string(name: 'REPO_BRANCH', defaultValue: 'main', description: 'Branch to checkout')
        string(name: 'IMAGE_NAME_BACKEND', defaultValue: 'community-platform-plus-backend', description: 'Docker image name for backend')
        string(name: 'N8N_WEBHOOK_URL', defaultValue: 'https://35.247.160.122:5678/webhook-test/627982e1-ee55-4a89-a91a-901e8436b313', description: 'n8n Test Webhook URL')

        booleanParam(name: 'Run_Checkmarx', defaultValue: false, description: 'Run Checkmarx scan')
    }

    environment {
        APP_REPO_URL    = "${params.REPO_URL}"
        APP_REPO_BRANCH = "${params.REPO_BRANCH}"
        IMAGE_NAME_BACKEND = "${params.IMAGE_NAME_BACKEND}"
        IMAGE_TAG = "${BUILD_NUMBER}" 
    }

    stages {
        stage('Clone Repository') {
            steps {
                cleanWs()
                git branch: "${APP_REPO_BRANCH}",
                    url: "${APP_REPO_URL}"
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                  echo "Installing depaendencies..."
                  npm install
                '''
            }
        }


        stage('SAST - Checkmarx') {
            when {
                expression { return params.Run_Checkmarx == true }
            }
            steps {
                script {
                    try {
                        // Use a background process to monitor and capture reports during scan
                        echo "üîç Starting background monitor for Checkmarx reports..."
                        
                        sh '''
                            # Start background monitor process
                            (
                                for i in {1..300}; do  # Monitor for up to 5 minutes
                                    if ls cx.tmp*/checkmarx-ast-results.* 2>/dev/null; then
                                        echo "Reports found! Copying..."
                                        for tmpdir in cx.tmp*; do
                                            if [ -d "$tmpdir" ]; then
                                                if [ -f "$tmpdir/checkmarx-ast-results.json" ]; then
                                                    cp "$tmpdir/checkmarx-ast-results.json" ./checkmarx-report.json
                                                    echo "JSON report copied from $tmpdir"
                                                fi
                                                if [ -f "$tmpdir/checkmarx-ast-results.html" ]; then
                                                    cp "$tmpdir/checkmarx-ast-results.html" ./checkmarx-report.html
                                                    echo "HTML report copied from $tmpdir"
                                                fi
                                            fi
                                        done
                                        break
                                    fi
                                    sleep 2
                                done
                            ) &
                        '''
                        
                        // Run the Checkmarx scan
                        checkmarxASTScanner additionalOptions: '--project-groups intern --scan-types "sast,sca" --report-format summaryJSON,summaryHTML --output-name checkmarx-results',
                            baseAuthUrl: '',
                            branchName: "${APP_REPO_BRANCH}",
                            checkmarxInstallation: 'Checkmarx',
                            credentialsId: '',
                            projectName: "SanctuaryV/community-platform-plus-frontend",
                            serverUrl: '',
                            tenantName: '',
                            useOwnAdditionalOptions: true
                        
                        // Give the background process a moment to finish
                        sleep(3)
                        
                        // Check what we captured
                        echo "üìã Checking captured reports..."
                        sh 'ls -la checkmarx-report.* || echo "No reports captured by background monitor"'
                        
                    } catch (Exception e) {
                        echo "‚ùå Checkmarx scan failed: ${e.getMessage()}"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }

                stage('Build Docker Image') {
            steps {
             
                    sh '''
                        echo "Building backend Docker image..."
                        docker build --no-cache -t $IMAGE_NAME_BACKEND:$IMAGE_TAG .
                        docker images | grep $IMAGE_NAME_BACKEND
                    '''
                
            }
        }

    }
    post {
        always {
            script {
                def jobResult = currentBuild.result ?: 'SUCCESS'
                def failedStage = 'None'
                
                if (jobResult != 'SUCCESS') {
                    failedStage = env.STAGE_NAME ?: 'Unknown Stage'
                }

                def bangkokTimeZone = TimeZone.getTimeZone('Asia/Bangkok')
                def dateFormat = new java.text.SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
                dateFormat.setTimeZone(bangkokTimeZone)
                
                def checkmarxReport = null
                if (params.Run_Checkmarx) {
                    echo "üîç Searching for Checkmarx reports..."
                    
                    try {
                        // First, let's see what files are in the workspace
                        echo "üìÅ Listing workspace contents:"
                        sh 'ls -la'
                        
                        echo "üîç Searching for any Checkmarx files:"
                        sh 'find . -name "*checkmarx*" -type f || echo "No checkmarx files found"'
                        
                        // First check for copied reports in workspace root
                        if (fileExists('checkmarx-report.json')) {
                            echo "‚úÖ Found copied JSON report: checkmarx-report.json"
                            def jsonContent = readFile('checkmarx-report.json')
                            checkmarxReport = [
                                format: 'json',
                                content: jsonContent,
                                summary: 'Checkmarx AST scan results in JSON format (copied to workspace)',
                                filePath: 'checkmarx-report.json',
                                fileSize: jsonContent.length()
                            ]
                        } else if (fileExists('checkmarx-report.html')) {
                            echo "‚úÖ Found copied HTML report: checkmarx-report.html"
                            def htmlContent = readFile('checkmarx-report.html')
                            checkmarxReport = [
                                format: 'html',
                                content: htmlContent,
                                summary: 'Checkmarx AST scan results in HTML format (copied to workspace)',
                                filePath: 'checkmarx-report.html',
                                fileSize: htmlContent.length()
                            ]
                        } else {
                            // Fallback: Search for original files
                            def jsonFile = sh(script: 'find . -name "checkmarx-ast-results.json" -type f | head -1', returnStdout: true).trim()
                            echo "JSON search result: '${jsonFile}'"
                            
                            if (jsonFile && jsonFile != '') {
                                echo "‚úÖ Found original JSON report: ${jsonFile}"
                                def jsonContent = readFile(jsonFile)
                                checkmarxReport = [
                                    format: 'json',
                                    content: jsonContent,
                                    summary: 'Checkmarx AST scan results in JSON format (original location)',
                                    filePath: jsonFile,
                                    fileSize: jsonContent.length()
                                ]
                            } else {
                                def htmlFile = sh(script: 'find . -name "checkmarx-ast-results.html" -type f | head -1', returnStdout: true).trim()
                                echo "HTML search result: '${htmlFile}'"
                                
                                if (htmlFile && htmlFile != '') {
                                    echo "‚úÖ Found original HTML report: ${htmlFile}"
                                    def htmlContent = readFile(htmlFile)
                                    checkmarxReport = [
                                        format: 'html',
                                        content: htmlContent,
                                        summary: 'Checkmarx AST scan results in HTML format (original location)',
                                        filePath: htmlFile,
                                        fileSize: htmlContent.length()
                                    ]
                                } else {
                                    echo "‚ùå No Checkmarx report files found anywhere"
                                    checkmarxReport = [
                                        format: 'error',
                                        content: null,
                                        summary: 'No Checkmarx report files found after thorough search (original and copied)',
                                        filePath: 'not found',
                                        searchAttempts: 'Checked copied files and original locations'
                                    ]
                                }
                            }
                        }
                    } catch (Exception e) {
                        echo "‚ùå Error searching for Checkmarx reports: ${e.getMessage()}"
                        checkmarxReport = [
                            format: 'error',
                            content: null,
                            summary: 'Failed to search for Checkmarx report: ' + e.getMessage(),
                            filePath: 'error',
                            exception: e.getClass().getSimpleName()
                        ]
                    }
                } else {
                    echo "‚è≠Ô∏è Checkmarx scan was skipped"
                }

                def payload = [
                    jobName: env.JOB_NAME,
                    buildNumber: env.BUILD_NUMBER,
                    jobResult: jobResult,
                    isSuccess: jobResult == 'SUCCESS',
                    triggeredBy: currentBuild.getBuildCauses('hudson.model.Cause$UserIdCause')?.get(0)?.userId ?: 'System',
                    startTime: dateFormat.format(new Date(currentBuild.startTimeInMillis)),
                    endTime: dateFormat.format(new Date()),
                    duration: currentBuild.durationString,
                    failedStage: failedStage,
                    timezone: 'Asia/Bangkok',
                    repository: [
                        url: params.REPO_URL,
                        branch: params.REPO_BRANCH
                    ],
                    buildUrl: env.BUILD_URL,
                    parameters: [
                        imageName: params.IMAGE_NAME_BACKEND,
                        runCheckmarx: params.Run_Checkmarx
                    ],
                    checkmarxReport: checkmarxReport
                ]

                try {
                    httpRequest(
                        httpMode: 'POST',
                        url: params.N8N_WEBHOOK_URL,
                        contentType: 'APPLICATION_JSON',
                        requestBody: groovy.json.JsonOutput.toJson(payload),
                        timeout: 30,
                        ignoreSslErrors: true,
                        acceptType: 'APPLICATION_JSON',
                        validResponseCodes: '200:299',
                        quiet: false
                    )
                    echo "‚úÖ Webhook sent to n8n (self-signed SSL) successfully"
                } catch (Exception e) {
                    echo "‚ùå Failed to send webhook to n8n: ${e.getMessage()}"
                    if (e.getMessage().contains('SSL') || e.getMessage().contains('certificate')) {
                        echo "Note: This appears to be an SSL certificate issue with self-signed certificates"
                    }
                }
            }
        }
    }
}

