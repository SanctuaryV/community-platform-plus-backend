pipeline {
  agent any

  parameters {
    // === Repo & Build ===
    string(name: 'REPO_URL',     defaultValue: 'https://github.com/SanctuaryV/community-platform-plus-backend.git', description: 'Git repo URL')
    string(name: 'REPO_BRANCH',  defaultValue: 'main', description: 'Branch to checkout')
    string(name: 'IMAGE_NAME_BACKEND', defaultValue: 'community-platform-plus-backend', description: 'Docker image name for backend')
    string(name: 'N8N_WEBHOOK_URL', defaultValue: 'https://35.247.160.122:5678/webhook/627982e1-ee55-4a89-a91a-901e8436b313', description: 'n8n Production Webhook URL')

    // === Checkmarx toggle ===
    booleanParam(name: 'Run_Checkmarx', defaultValue: true, description: 'Run Checkmarx scan')

    // === Checkmarx One (ค่า default จาก log ล่าสุดของคุณ) ===
    string(name: 'CX_PROJECT_NAME',   defaultValue: 'SanctuaryV/community-platform-plus-backend', description: 'Checkmarx project name')
  }

  environment {
    // === Map params → env ===
    APP_REPO_URL       = "${params.REPO_URL}"
    APP_REPO_BRANCH    = "${params.REPO_BRANCH}"
    IMAGE_NAME_BACKEND = "${params.IMAGE_NAME_BACKEND}"
    IMAGE_TAG          = "${BUILD_NUMBER}"

    CX_PROJECT_NAME    = "${params.CX_PROJECT_NAME}"
  }

  stages {
    stage('Checkout SCM (Jenkinsfile)') {
      steps {
        checkout scm
      }
    }

    stage('Clone Repository') {
      steps {
        cleanWs()
        git branch: "${env.APP_REPO_BRANCH}", url: "${env.APP_REPO_URL}"
      }
    }

    stage('Install Dependencies') {
      steps {
        sh '''
          echo "Installing dependencies..."
          if command -v npm >/dev/null 2>&1; then
            npm ci || npm install
          else
            echo "npm not found"; exit 1
          fi
        '''
      }
    }

    stage('Validate Checkmarx Config') {
      when { expression { return params.Run_Checkmarx } }
      steps {
        script {
          if (!env.CX_SERVER_URL?.trim())   error "CX_SERVER_URL is empty"
          if (!env.CX_TENANT?.trim())       error "CX_TENANT is empty"
          if (!env.CX_PROJECT_NAME?.trim()) error "CX_PROJECT_NAME is empty"
          if (!env.CX_CREDENTIALS_ID?.trim()) error "CX_CREDENTIALS_ID is empty"
          echo "✅ Checkmarx config OK: ${env.CX_SERVER_URL} | ${env.CX_TENANT} | ${env.CX_PROJECT_NAME}"
        }
      }
    }

    stage('SAST - Checkmarx') {
      when { expression { return params.Run_Checkmarx } }
      steps {
        // ใช้ปลั๊กอิน AST เรียก CLI ใต้ท้องให้ generate SARIF → reports/checkmarx.sarif
        checkmarxASTScanner(
          serverUrl: '',
          tenantName: '',
          credentialsId: '',
          projectName: "${env.CX_PROJECT_NAME}",
          branchName: "${env.APP_REPO_BRANCH}",
          checkmarxInstallation: 'Checkmarx',
          useOwnAdditionalOptions: true,
          additionalOptions: """
            --scan-types "sast,sca"
            --sast-incremental true
            --report-format sarif
            --output-name checkmarx
            --output-path reports
            --project-groups intern
            --scan-types "sast,sca"
          """.trim()
        )
      }
    }

    stage('Publish Checkmarx Report to Jenkins') {
      when { expression { return params.Run_Checkmarx } }
      steps {
        // แสดงผล + ตั้ง quality gate ด้วย Warnings NG (fail เมื่อ High > 0)
        recordIssues(
          tools: [sarif(pattern: 'reports/*.sarif')],
          qualityGates: [[threshold: 0, type: 'TOTAL', criticality: 'HIGH']],
          failOnError: true
        )
      }
    }

    stage('Archive Reports') {
      when { expression { return params.Run_Checkmarx } }
      steps {
        archiveArtifacts artifacts: 'reports/**', fingerprint: true
      }
    }

    stage('Build Docker Image') {
      steps {
        sh '''
          echo "Building backend Docker image..."
          docker build --no-cache -t $IMAGE_NAME_BACKEND:$IMAGE_TAG .
          docker images | grep $IMAGE_NAME_BACKEND || true
        '''
      }
    }

    stage('Send Checkmarx Summary to n8n') {
      when { expression { return params.Run_Checkmarx } }
      steps {
        script {
          def sarifPath = 'reports/checkmarx.sarif'
          def totalFindings = 0
          def highCount = 0
          def mediumCount = 0
          def lowCount = 0

          if (fileExists(sarifPath)) {
            def sarifText = readFile(sarifPath)
            def sarifJson = new groovy.json.JsonSlurperClassic().parseText(sarifText)
            def results = sarifJson?.runs?.getAt(0)?.results ?: []
            totalFindings = results.size()

            // Map severity แบบง่ายจาก SARIF level: error=HIGH, warning=MEDIUM, note/none=LOW
            results.each { r ->
              def lvl = (r?.level ?: '').toString().toLowerCase()
              if (lvl == 'error')      highCount++
              else if (lvl == 'warning') mediumCount++
              else                      lowCount++
            }
          }

          def bangkokTZ = TimeZone.getTimeZone('Asia/Bangkok')
          def fmt = new java.text.SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
          fmt.setTimeZone(bangkokTZ)

          def summary = [
            tool        : 'checkmarx',
            project     : env.CX_PROJECT_NAME,
            branch      : env.APP_REPO_BRANCH,
            total       : totalFindings,
            high        : highCount,
            medium      : mediumCount,
            low         : lowCount,
            reportUrl   : "${env.BUILD_URL}artifact/reports/checkmarx.sarif",
            buildNumber : env.BUILD_NUMBER,
            buildUrl    : env.BUILD_URL,
            time        : fmt.format(new Date())
          ]

          httpRequest(
            httpMode: 'POST',
            url: params.N8N_WEBHOOK_URL,
            contentType: 'APPLICATION_JSON',
            requestBody: groovy.json.JsonOutput.toJson(summary),
            timeout: 30,
            ignoreSslErrors: true,
            acceptType: 'APPLICATION_JSON',
            validResponseCodes: '200:299',
            quiet: false
          )
          echo "✅ Sent Checkmarx summary to n8n"
        }
      }
    }
  }

  post {
    always {
      script {
        def jobResult = currentBuild.result ?: 'SUCCESS'
        def failedStage = 'None'
        if (jobResult != 'SUCCESS') {
          failedStage = env.STAGE_NAME ?: 'Unknown Stage'
        }

        def bangkokTZ = TimeZone.getTimeZone('Asia/Bangkok')
        def fmt = new java.text.SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
        fmt.setTimeZone(bangkokTZ)

        def payload = [
          jobName    : env.JOB_NAME,
          buildNumber: env.BUILD_NUMBER,
          jobResult  : jobResult,
          isSuccess  : jobResult == 'SUCCESS',
          triggeredBy: currentBuild.getBuildCauses('hudson.model.Cause$UserIdCause')?.get(0)?.userId ?: 'System',
          startTime  : fmt.format(new Date(currentBuild.startTimeInMillis)),
          endTime    : fmt.format(new Date()),
          duration   : currentBuild.durationString,
          failedStage: failedStage,
          timezone   : 'Asia/Bangkok',
          repository : [ url: params.REPO_URL, branch: params.REPO_BRANCH ],
          buildUrl   : env.BUILD_URL,
          parameters : [ imageName: params.IMAGE_NAME_BACKEND, runCheckmarx: params.Run_Checkmarx ]
        ]

        try {
          httpRequest(
            httpMode: 'POST',
            url: params.N8N_WEBHOOK_URL,
            contentType: 'APPLICATION_JSON',
            requestBody: groovy.json.JsonOutput.toJson(payload),
            timeout: 30,
            ignoreSslErrors: true,
            acceptType: 'APPLICATION_JSON',
            validResponseCodes: '200:299',
            quiet: false
          )
          echo "✅ Webhook sent to n8n (self-signed SSL) successfully"
        } catch (Exception e) {
          echo "❌ Failed to send webhook to n8n: ${e.getMessage()}"
          if (e.getMessage().contains('SSL') || e.getMessage().contains('certificate')) {
            echo "Note: This appears to be an SSL certificate issue with self-signed certificates"
          }
        }
      }
    }
  }
}
