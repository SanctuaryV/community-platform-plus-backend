name: community-platform-plus

services:
  mysql:
    image: mysql:8.0
    container_name: mysql-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: community_platform
      MYSQL_USER: appuser
      MYSQL_PASSWORD: apppass
    ports:
      - "3307:3306"   # host:container (avoid clashing with local MySQL on 3306)
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpass"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  backend:
    build: .   # Build from local Dockerfile
    container_name: backend
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
    # Option 1: Use .env file (recommended)
    env_file:
      - .env
    # Option 2: Inline environment variables (override .env if needed)
    environment:
      # Database - must match mysql service config
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: community_platform
      DB_USER: appuser
      DB_PASS: apppass
      # Server Configuration
      NODE_ENV: production
      PORT: 5000
      HOST: 0.0.0.0
      # CORS - Update this for production deployment
      CORS_ORIGIN: http://localhost:3000
      # JWT Configuration
      JWT_SECRET: token-for-join
      JWT_EXPIRES_IN: 1h
      # Socket.IO Configuration
      SOCKET_PATH: /socket.io
      SOCKET_TRANSPORTS: websocket,polling
      # File Upload Configuration
      UPLOAD_DIR: uploads
      POST_DIR: post
      MAX_FILE_SIZE: 10485760
      # Rate Limiting
      RATE_LIMIT_WINDOW_MS: 900000
      RATE_LIMIT_MAX_REQUESTS: 100
    ports:
      - "5050:5000"   # Backend runs on port 5000 internally, exposed on 5050
    volumes:
      - ./uploads:/app/uploads

  frontend:
    build: ../community-platform-plus-frontend   # Build from frontend Dockerfile
    container_name: frontend
    restart: always
    depends_on:
      - backend
    ports:
      - "3000:80"     # assuming frontend image is served by nginx on 80
    # Option 1: Use .env file (recommended) - uncomment to use
    # env_file:
    #   - ../community-platform-plus-frontend/.env
    # Option 2: Inline environment variables (current setup)
    environment:
      # API Configuration - Update for production deployment
      REACT_APP_API_URL: http://localhost:5050/api
      REACT_APP_SOCKET_URL: http://localhost:5050
      REACT_APP_SOCKET_PATH: /socket.io
      REACT_APP_SOCKET_TRANSPORTS: websocket,polling
      # App Metadata
      REACT_APP_NAME: Community Platform Plus
      REACT_APP_VERSION: 1.0.0
      REACT_APP_DESCRIPTION: A modern community platform
      # Feature Flags
      REACT_APP_ENABLE_NOTIFICATIONS: true
      REACT_APP_ENABLE_DARK_MODE: true

volumes:
  db_data: